%% Response Generation System
%% Main flow: Trigger → Queue → Generate → Review → Send

flowchart TB
    subgraph Trigger["Trigger"]
        NEW_MSG[New Customer Message]
        MANUAL[Manual Generate]
    end

    subgraph Queue["Redis Queue"]
        RQ[(Queue)]
    end

    subgraph Worker["Worker"]
        PROC[Processor]
        DNA[Load Org DNA]
        BUILD[Build Prompt]
        GEN[Generate]
    end

    LLM[Gemini AI]

    subgraph DB["Database"]
        GR[(generated_responses)]
        OS[(organization_style)]
        MSG[(messages)]
    end

    subgraph Review["Review Flow"]
        CHECK{Confidence > Threshold?}
        AUTO_CHK{Auto-Send Enabled?}
        PENDING[Pending Review]
        ACCEPT[Accept]
        REJECT[Reject]
        REPROMPT[Reprompt]
    end

    SEND[Send to Customer]

    %% Generation Flow
    NEW_MSG -->|auto-reply on| RQ
    MANUAL --> RQ
    RQ --> GR
    RQ --> PROC
    PROC --> DNA
    DNA --> OS
    DNA --> BUILD
    BUILD --> GEN
    GEN <--> LLM
    GEN --> GR

    %% Review Flow
    GR --> CHECK
    CHECK -->|Yes + auto_accept| AUTO_CHK
    CHECK -->|No or manual| PENDING
    AUTO_CHK -->|Yes| SEND
    AUTO_CHK -->|No| PENDING

    PENDING --> ACCEPT
    PENDING --> REJECT
    PENDING --> REPROMPT

    ACCEPT --> SEND
    REJECT --> GR
    REPROMPT -->|new version| RQ

    %% Send Flow
    SEND --> MSG
    SEND --> GR

    %% Styling
    style NEW_MSG fill:#3ECF8E,color:#000
    style LLM fill:#4285F4,color:#fff
    style RQ fill:#DC382D,color:#fff
    style GR fill:#FF9800,color:#000
    style OS fill:#9C27B0,color:#fff
    style SEND fill:#4CAF50,color:#fff
