flowchart LR
    subgraph Platform["Existing Platform"]
        SP[(Supabase DB)]
        WH[Webhook]
        CLIENT[Client App]
    end

    subgraph API["Cloud Run - API"]
        RECV[Webhook Receiver]
        GEN_EP[Generate Response API]
    end

    subgraph Cache["Redis"]
        RQ[Queue]
        RC[Cache]
    end

    subgraph Worker["Cloud Run - Worker"]
        PROC[Processor]
        CL[Classifier]
        RG[Response Gen]
    end

    VA[Gemini AI]

    %% Classification + Auto-Response Flow
    SP -->|Event| WH
    WH --> RECV
    RECV --> RQ
    RQ --> PROC
    PROC --> CL
    CL <-->|Classify + Extract| VA
    CL --> RC
    CL -->|Result| SP
    PROC -->|If Auto-Reply| RG
    RG <-->|Generate| VA
    RG -->|Send Response| SP

    %% Manual Response Generation
    CLIENT --> GEN_EP
    GEN_EP --> RG
    GEN_EP -->|Response| CLIENT

    style SP fill:#3ECF8E,color:#000
    style VA fill:#4285F4,color:#fff
    style RQ fill:#DC382D,color:#fff
    style RC fill:#DC382D,color:#fff
    style GEN_EP fill:#FF9800,color:#000
    style RG fill:#FF9800,color:#000
